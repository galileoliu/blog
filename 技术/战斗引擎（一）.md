# 浅谈《无尽远征》战斗引擎（一）

《无尽远征》是一款2D横版的MMO手机游戏。游戏使用cocos2d-x引擎开发，其战斗引擎使用C++和Lua语言编写，基于帧同步模型实现战斗过程的逻辑。

如果要用一句话来概括《无尽远征》的核心战斗的话，那就是基于开房间模式的即时战斗。角色的状态分为非战斗和战斗两种，当玩家由非战斗进入战斗状态时，战斗服务器生成这场战斗独立的房间，参与战斗的角色所在的客户端程序连接进入房间开始战斗过程。在战斗过程中，客户端发送角色的操作指令，战斗服务器接收处理所有指令并发送给其他客户端，二者使用相同的战斗引擎代码进行战斗过程演算。战斗结束后，战斗服务器将结果发送到游戏服务器，并关闭当前房间。

在写战斗引擎的实现细节之前，需要先说明核心战斗设计的整体规则。

## 战斗规则

整体的战斗规则可以分为三个部分来讲，目标选择、自动位移和技能释放过程。

### 目标选择

通常情况下，角色在战斗过程中需要选择一个在其视野范围内的目标单位来释放技能。目标可以通过玩家操作来手动指定，也可以通过技能的选择目标逻辑来进行自动选择。

#### 视野范围

每一个单位都有一个视野范围，其定义是以单位的质心为圆心，半径为N的圆形区域。处在单位视野范围内的其他单位可以被选择为单位的目标。

#### 玩家操作手动选择目标

1. 点击单位模型，选择对应的单位为目标

2. 点击单位头像，选择对应的单位为目标

3. 点击切换目标按钮，按照一定的规则选择目标：
   * 如果玩家没有目标，在其点击切换目标按钮后，系统需自动为其选中一个敌方单位作为目标，选择的逻辑为：
      * 如果角色的视野范围内有敌方单位，则选择角色面前最近的敌方单位作为目标，如果角色面前没有敌方单位，则选择距离角色最近的敌方单位作为目标
      * 如果角色的视野范围内没有敌方单位，则需要弱提示玩家：“你的周围没有敌人。”
   * 如果玩家已有目标，在其点击切换敌方目标按钮后，切换目标的逻辑为：
      * 无论角色身后有无目标，只要其身前有目标，就只选择视野范围内的，角色身前的敌方目标，只在角色身前没有目标时，才选择角色身后的目标

#### 技能选择目标

玩家点击技能按钮释放技能时，如果角色没有目标，但技能释放需要一个目标时，战斗引擎会自动选择一个目标。默认的目标选择规则是：如果视野范围内有单位，则优先选择角色面前最近的一个单位；如果角色面前没有单位，则根据由近及远的规则选择角色身后的一个单位。
此外，技能还需支持多种目标选择逻辑，例如血量最低的目标、等级最高的目标等等，这个逻辑通过技能的配置来决定。技能的目标并不一定是战斗单位，也可以是某个坐标点、战场范围或某个方向等。
为了提升战斗体验，需要特别注意的是，如果在玩家操作技能实施的过程中，玩家切换了自己的目标，则当前技能仍需作用于上一个有效目标。

#### 目标丢失规则

在战斗过程中，角色当前的目标有可能会自动丢失，可以分为下列情况：

1. 目标离开了角色的视野范围
2. 点击方向键来改变角色朝向会导致目标丢失，有两种情况：
   * 改变朝向之前，角色面对目标，目标丢失
   * 改变朝向之前，角色背对目标，目标不丢失
3. 玩家移动（或其他原因）导致玩家背对目标，目标丢失
4. 目标死亡
5. 受到技能效果的影响
6. 角色进入了特殊状态

#### 锁定目标规则

玩家可以通过点击锁定按钮来切换当前目标的锁定状态。目标被锁定后，切换敌方目标按钮将会失效。即使玩家改变角色的朝向，目标也不会丢失。如果玩家手动选择了其他目标，之前被锁定的目标的锁定状态就会被自动移除。

### 自动位移

因为我们的游戏并不是一个纯粹的动作游戏，因此需要一些额外的功能来提升玩家的操作舒适感——大多数情况下，角色的普通攻击和技能都有距离限制，而当角色与目标之间距离太远时，角色应自动跑向目标，再进行下一步操作。说明具体规则需要引入下面两个概念。

#### 角色的碰撞范围

* 以角色质心为中点，长度等于N米的线段所对应的范围即为角色的碰撞范围
* N可由策划配置，不同角色的碰撞体积可能不同
* *角色的碰撞“半径”=N/2

#### 角色的攻击距离

* 以角色质心为起点，长度为N米的距离
* N由角色使用的武器决定，可由策划配置
* 当技能配置中的“施法距离”字段上的配置为“特殊参数”时，角色的攻击距离由N决定；当此配置为具体数值时，角色的攻击距离由配置决定

#### 具体规则

玩家进行释放技能操作之后（包括普通攻击），有以下两种情况：

1. 角色与目标双方的质心之间的距离R大于角色的攻击距离+目标的碰撞半径，则角色应跑向目标，直到R等于角色的攻击距离+目标的碰撞半径，再进行下一步操作。在角色跑向目标的过程中，还有以下几种情况

   * 若玩家正向点击方向按钮，不要打断此过程
   * 若玩家点击普通攻击按钮，不要打断此过程
   * 若玩家反向点击方向按钮，需立即打断此过程
   * 若玩家点击技能按钮，程序需根据技能的具体设定作出适当的处理

2. 角色与目标双方的质心之间的距离R小于双方的碰撞半径之和，如果玩家没有进行移动操作，则其控制的角色需在普通攻击的过程中向后滑动（程序处理）M米，直到R等于双方的碰撞半径之和（最后一次后退的距离可能小于M米）


以上就是对战斗设计规则的整体说明。我会在下一篇文章里​介绍具体的技能释放过程。