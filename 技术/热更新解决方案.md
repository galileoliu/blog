# 热更新解决方案

## 问题

为了快速发布最新的游戏版本，移动平台游戏在运营期间需要热更新功能。更新的内容为游戏资产，包括策划配置，美术资产及脚本逻辑代码

## 概念

### 游戏版本号

一个表示游戏版本的字符串

1. 由数字和符号‘.’组成字符串，形式为a.b.c.d
2. a.b表示游戏App**可执行程序**的版本号（也习惯称之为**二进制**版本号），具体含义为：a表示**主要版本号**，在有资料片级别的重大可执行程序更新时增加；b表示**次要版本号**，在月度或季度版本更新需要修改可执行程序内容时增加
3. c表示构建版本号，表示App商店提审序号变化，在可执行程序版本号相同但需要重新提交App商店审核时增加
4. d表示资产版本号，表示资产变化，在资产有变化时增加。一般情况下，可以设置为版本制作时间点上，版本控制工具中资产的变动序号

### 强制更新

移动平台（iOS及Android）上App的可执行程序发生变化时，需要提交新的版本到App商店进行审核，审核通过后App商店分发给玩家进行更新。通常在这种情况下，玩家如果选择不更新，是无法保证游戏逻辑进行正常的，所以称为强制更新。因为玩家需要重新下载完整的App，需要消耗较大的流量和等待较长的时间，可能造成玩家流失，所以应当尽量避免强制更新

### 热更新

与强制更新相对应，移动平台上App的可执行程序没有发生变化，仅需要更新游戏资产就可以实现新版本的分发，这种更新称之为热更新。由于不需要经过App商店审核，这种更新内容可以非常快速地分发给玩家。玩家也不需要重新下载App全量包，仅需要下载变动的资产部分即可正常进行游戏，相对而言减小了玩家流失的风险

### 可写目录

移动平台的App都会有一个可以访问的沙盒目录，用来读写App自定义的各种文件

### 网关服务器

游戏服务器的一种，提供版本号、游戏大区及服务器列表、角色列表等信息，是网络游戏中客户端程序首先连接的服务器

### CDN服务器

CDN的全称是Content Delivery Network，即内容分发网络。网络游戏的热更新功能依赖CDN服务器的内容存储和分发功能，一般由第三方云服务商提供

## 基本原理

基于两个版本的差异制作更新包，更新包下载到手机的可写目录，客户端程序按照规定的顺序搜索目录加载资产，实现游戏的版本升级

## 流程

### 基本流程

1. 程序启动获得当前的可执行程序版本号a.b.c，上一次启动时记录的版本号进行对比。如果前者大于后者，则为强制更新后覆盖安装App的情况，需要清理可写目录下的热更新文件存储目录。记录这次启动时可执行程序版本号
2. 读取配置文件中是否开启热更新的标志。如果热更新为关闭状态，则跳过热更新流程直接进入游戏；反之，则进入后续流程
3. 向**网关服务器**发送请求来获取最新的版本号，该版本号称为远程版本号。如果本地版本号和远程版本号相同，则直接进入游戏；如果本地版本号小于远程版本号，则进入后续流程
4. 根据最新的版本号从**CDN服务器**下载最新的资产版本配置文件。下载完成后，将它和本地的资产版本配置文件文件进行对比，确定需要更新的更新包内容
5. 启动下载器下载更新包。更新包下载顺序没有要求，可以使用多线程进行
6. 更新包下载完成后，按照资产版本配置文件中规定的顺序依次解压更新包到可写目录
7. 将最新的资产版本配置文件存储覆盖本地的配置文件，完成热更新流程
8. 加载资产，进入游戏逻辑流程

### 流程图

![http-bw](./热更新流程图.svg)

## 资产版本配置文件

配置文件为json格式

初始资产版本配置文件

    {
        "version": "0", 
        "assets": {}, 
        "remoteManifestUrlTemplate": "project_%s.manifest"
    }

假设当前资产版本号为3，Manifest配置文件如下：

    {
        "version": "3", 
        "assets": {
            "assets_patch_1_2.zip": {
                "size": 5148965, 
                "decompressOrder": 1, 
                "compressed": true, 
                "md5": "2076c51d486f8ff805989c8ddbc579d9"
            }, 
            "assets_patch_0_1.zip": {
                "md5": "29732dd36540d7d7e86bbdb24d085eb5", 
                "decompressOrder": 0, 
                "compressed": true, 
                "size": 3935696
            }, 
            "assets_patch_2_3.zip": {
                "md5": "91af20dc109e57ee7c2ff312e7930193", 
                "size": 3196991, 
                "decompressOrder": 2, 
                "compressed": true
            }
        }, 
        "remoteManifestUrlTemplate": "project_%s.manifest"
    }

字段含义

* version 资产版本号
* assets 资产更新包信息，字典的key为更新包名称，value为更新包信息object
* md5 更新包md5值
* size 更新包大小，单位为字节
* compressed 是否压缩
* decompressOrder 解压顺序号，序号小的优先解压
* remoteManifestUrlTemplate CDN服务器上的Manifest配置文件名模版，和当前资产版本号配合使用

## 注意事项

* CDN服务站点需要两个以上，以防止站点不可用阻碍游戏的正常更新
* 热更新流程中需要对每一种异常情况进行合理提示，并且给玩家重启热更新流程的操作
* 对流程进行打点信息统计，以便在问题发生时进行准确定位