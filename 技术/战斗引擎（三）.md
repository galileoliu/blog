# 浅谈《无尽远征》战斗引擎（三）

这篇文章主要介绍战斗引擎的具体实现方法。

## 帧同步模型

### 基本原理

帧同步（Lockstep）模型又被称为锁步同步模型，最早被引入计算机软件领域是应用于计算机容错系统中。它的基本思想是，对于同一个软件系统，通过输入相同的操作一定能够得到相同的运算结果。第一代FPS游戏《Doom》首次将该模型引入游戏开发领域，用于在局域网对战中进行网络通讯，保证每个游戏程序的运算结果一致，从而给每一个玩家提供相同的游戏体验。

![http-bw](./battle-engine-2.png)

如上图所示，帧同步模型的游戏程序使用相同的时间周期（Turn）进行运算迭代。在某个时间周期内，游戏程序会向在同一局对战内的其他游戏程序发送玩家的操作指令；当到达时间周期的末尾时，所有游戏程序根据收到的所有玩家操作指令进行运算，改变游戏状态。这个过程贯穿一局对战的始终，直至游戏分出胜负而结束。

### 常见问题

1. 数值精度问题

* 由于不同架构的CPU指令集不同，浮点数运算的结果可能会产生误差。如果游戏程序在运算过程中使用了浮点数运算（常见于物理引擎），在相同的玩家输入的情况下，计算结果可能会不同，从而影响游戏的体验。这种误差对于游戏的公平性和体验有较大影响，是不可接受的。

2. 囚徒模式

* 在网络状况不好的情况下，网络波动会造成玩家输入信息通讯的延迟卡顿，从而影响玩家的游戏体验。

3. 断线重连问题

* 一旦游戏过程中网络断开

### 实现方式

