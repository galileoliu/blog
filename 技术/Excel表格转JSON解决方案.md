# Excel表格转JSON解决方案

## 概述

配置数据是游戏资产的重要组成部分，角色的属性、技能的强度、道具的名称等等都属于这个范畴。通常情况下，这些配置数据是由游戏策划通过Excel表格工具来进行编辑和存储。之所以选择Excel，是因为其拥有强大且便捷的数据处理和编辑功能。但是由于Excel表格文件在存储格式、存储体积、解析复杂度、可读性及跨平台等方面的特性，游戏程序在运行时通常不会直接加载Excel表格文件来读取配置数据。在笔者之前的关于《无尽远征》战斗引擎的文章中有提到，战斗相关的配置数据是以JSON文件的形式加载的，本文将介绍《无尽远征》中使用的Excel文件转换为JSON文件的解决方案。

## 表格设计

为了能够让Excel文件被配置数据转换工具识别并进行转换，我们需要设计一套匹配工具逻辑的Excel表格结构规则。这套规则可以分为表头、数据区、引用以及折叠四个部分。

### 表头

表头决定了Excel文件中一个工作表（sheet）的各种格式和内容信息

<table>
<tr><th>__default__</th><th></th><th></th><th></th><th></th><th></th></tr>
<tr><td>__folding__</td><td></td><td></td><td></td><td></td><td></td></tr>
<tr><td>__type__</td><td>s</td><td>i</td><td>i</td><td>i</td><td>i</td></tr>
<tr><td>__#__</td><td>怪物的名字</td><td></td><td></td><td></td><td></td></tr>
<tr><td>__name__</td><td>名称</td><td>血量</td><td>魔法</td><td>攻击</td><td>防御</td></tr>
</table>

表头最左侧是一些约定标记，这些标记表示了该行是什么参数类型：

-   `__type__`：必选标记，表示该行是字段类型

-   `__name__`：必选标记，表示该行是字段名

-   `__#__`：可选标记，注释行

-   `__default__`：可选标记，表示该行是缺省值

-   `__reference__`: 可选标记，表示该行是引用工作表的名称

-   `__folding__`：可选标记，表示该行是折叠属性，在高级功能中详述

#### 字段类型

字段类型是必选标记，工具中支持如下的字段类型：

-   s：字符串

-   i：整数

-   f：小数

-   b：布尔

-   as：字符串数组

-   ai：整数数组

-   af：小数数组

-   d：字典，若在字典中想使用数字字符串作为值，请在数字两端加""

-   r：引用，可以引用另一张工作表中的内容，在高级功能中详述

-   ar：引用数组，可以引用另一张工作表中的多行数据

-   o：表示该列数据不会导出到JSON文件中

#### 缺省值

缺省值是可选标记。如果该单元格是空白，程序会自动在该单元格上填写缺省值。

-   为了保证布尔判断的正确性，以及表格结构的完整性，所有默认的缺省值都是null

-   可以自定义缺省值，但与单元格一样，需要保证数据类型的正确性

### 数据区

在表头下面的，就是数据区。数据区的大小是程序自行判断的，为了保证程序正确判断数据区的单元格位置，请在数据区下面一行和最右侧一列，保持空白。在数据区之外的单元格，程序不会读取，可自由编辑。

#### 第一列数据

第一列数据为特殊数据，表示该行数据在工作表中的唯一标识ID，其在JSON文件中的关键字为“_id”。

#### null

null为保留字，在单元格中可以直接填写null为占位符。程序最终会输出null到JSON结构中。

#### 字段类型自动判断

如果当前单元格的数据没有填写对应的字段类型，程序将自动判断。只支持几种类型的自动判断：i，f，s。

### 引用

引用是一个字段类型，其类型值为r。引用允许在一张工作表中，插入另一张工作表中的一行。

<table>
<tr><th>__type__</th><th>r</th></tr><tr><td>__name__</td><td>lv1award</td></tr>
<tr><td>zhangsan</td><td>lvAward.lv1</td></tr>
</table>

在引用属性的单元格中，填写的是lvAward.lv1。该格式为约定格式“表名.记录名”。程序会在名为“lvAward”的工作表中，查找到名为“lv1”的记录，并把该记录，作为属性值插入到当前工作表中。

注意，不允许各个工作表之间循环引用。在单表模式下，被引用的表也不会输出。

### 折叠

折叠是一个可选字段属性。该功能允许把一张工作表中的字段，反复折叠，变成一个JSON，该JSON会填充到最后一次折叠对应的单元格中。

按JSON格式的特点，我们有两种折叠方式：

-   按{}折叠：折叠后，会生成一个字典

-   按[]折叠：折叠后，会生成一个数组

每一次折叠，不只会折叠数据。对应的字段类型，字段名，甚至折叠属性本身都会被折叠。我们约定，在折叠字段属性填写时，左侧括号后，必须紧接一个折叠后的字段名。折叠后的字段类型为d。

折叠本身的含义可能过于抽象，但其实质是非常简单的。下面演示了折叠的整个过程：

原始表

<table>
<tr><th>__folding__</th><th>{a{b</th><th></th><th>}</th><th></th><th>{c</th><th>}}</th></tr>
<tr><td>__type__</td><td>s</td><td>i</td><td>i</td><td>i</td><td>s</td><td>b</td></tr>
<tr><td>__name__</td><td>name</td><td>hp</td><td>atk</td><td>def</td><td>description</td><td>leader</td></tr>
</table>

第一次折叠
<table>
<tr><th>__folding__</th><th>{a</th><th></th><th>{c</th><th>}}</th></tr>
<tr><td>__type__</td><td>d</td><td>i</td><td>s</td><td>b</td></tr>
<tr><td>__name__</td><td>b</td><td>def</td><td>description</td><td>leader</td></tr>
</table>


第二次折叠
<table>
<tr><th>__folding__</th><th>{a</th><th></th><th>}</th></tr>
<tr><td>__type__</td><td>d</td><td>i</td><td>d</td></tr>
<tr><td>__name__</td><td>b</td><td>def</td><td>c</td></tr>
</table>

第三次折叠
<table>
<tr><th>__folding__</th><th></th></tr>
<tr><td>__type__</td><td>d</td></tr><tr>
<td>__name__</td><td>a</td></tr>
</table>

折叠后的JSON结构形如：

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    "a":{
        "b":{
            "name":"x x x",
            "hp":111,
            "atk":222
        },
        "def":333,
        "c":{
            "description":"x x x",
            "leader":false
        }
    }
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

### 引用与折叠的关系

特别注意，程序在进行数据输出时。先对每个工作表进行单独处理，此时会触发折叠操作。然后如果该工作表存在引用，再插入相应的数据。所以，引用插入的数据是不可以被折叠的。

## 转换工具

转换工具使用Python语言编写。之所以使用Python语言，是因为它拥有跨平台能力，并且有广泛的基础类库支持。
工具中对Excel文件的加载及解析使用xlrd库，对json文件的写入使用json库，根据上面描述的表格结构规则来组织工具代码的逻辑。其中要注意的是对引用的解析，需要加入循环引用的检查逻辑。